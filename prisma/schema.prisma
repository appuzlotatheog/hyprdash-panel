generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Note: SQLite doesn't support enums, so we use String types instead
// Role: ADMIN, MODERATOR, USER
// ServerStatus: OFFLINE, STARTING, RUNNING, STOPPING
// BackupStatus: PENDING, IN_PROGRESS, COMPLETED, FAILED

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  username              String    @unique
  password              String
  role                  String    @default("USER")
  twoFactorEnabled      Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret       String?   @map("two_factor_secret")
  groqApiKey            String?   @map("groq_api_key") // Custom Groq API key for AI features
  
  // Security fields
  failedLoginAttempts   Int       @default(0) @map("failed_login_attempts")
  lockedUntil           DateTime? @map("locked_until")
  lastLoginAt           DateTime? @map("last_login_at")
  lastLoginIp           String?   @map("last_login_ip")
  tokenVersion          Int       @default(0) @map("token_version") // Increment to invalidate all tokens
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  servers           Server[]
  subusers          Subuser[]
  apiKeys           ApiKey[]
  auditLogs         AuditLog[]
  sessions          Session[]
  invitationsSent   Invitation[] @relation("InvitedByUser")

  @@map("users")
}

model Session {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  token       String    @unique
  userAgent   String?   @map("user_agent")
  ipAddress   String?   @map("ip_address")
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model PasswordReset {
  id          String    @id @default(uuid())
  email       String
  token       String    @unique
  expiresAt   DateTime  @map("expires_at")
  usedAt      DateTime? @map("used_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("password_resets")
}

model ApiKey {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  name        String
  key         String    @unique
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model Node {
  id          String    @id @default(uuid())
  name        String
  fqdn        String
  port        Int       @default(8080)
  scheme      String    @default("https")
  token       String    @unique
  memory      Int       // Total memory in MB
  disk        Int       // Total disk in MB
  isOnline    Boolean   @default(false) @map("is_online")
  lastChecked DateTime? @map("last_checked")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  servers     Server[]
  allocations Allocation[]
  mounts      Mount[]
  databaseHosts DatabaseHost[]

  @@map("nodes")
}

model Allocation {
  id        String   @id @default(uuid())
  nodeId    String   @map("node_id")
  ip        String
  port      Int
  serverId  String?  @unique @map("server_id")
  notes     String?

  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  server    Server?  @relation(fields: [serverId], references: [id], onDelete: SetNull)

  @@unique([nodeId, ip, port])
  @@map("allocations")
}

model Egg {
  id              String    @id @default(uuid())
  name            String
  author          String?
  description     String?
  features        String?   // JSON array: ["eula", "java_version"]
  dockerImages    String?   @map("docker_images") // JSON: {"Java 21": "image:tag"}
  startup         String    // Startup command with {{VAR}} placeholders
  configFiles     String?   @map("config_files") // JSON config
  configStartup   String?   @map("config_startup") // JSON: {"done": "pattern"}
  stopCommand     String    @default("stop") @map("stop_command")
  scriptInstall   String?   @map("script_install") // Installation bash script
  scriptContainer String?   @map("script_container") // Docker image for install
  fileDenylist    String?   @map("file_denylist") // JSON array of denied files
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  servers     Server[]
  variables   EggVariable[]

  @@map("eggs")
}

model EggVariable {
  id           String   @id @default(uuid())
  eggId        String   @map("egg_id")
  name         String
  description  String?
  envVariable  String   @map("env_variable")
  defaultValue String?  @map("default_value")
  userViewable Boolean  @default(true) @map("user_viewable")
  userEditable Boolean  @default(true) @map("user_editable")
  rules        String?  // Validation rules like "required|string|max:20"
  fieldType    String   @default("text") @map("field_type") // text, select, etc.

  egg          Egg      @relation(fields: [eggId], references: [id], onDelete: Cascade)

  @@map("egg_variables")
}

model Server {
  id              String       @id @default(uuid())
  nodeId          String       @map("node_id")
  ownerId         String       @map("owner_id")
  eggId           String?      @map("egg_id")
  name            String
  description     String?
  memory          Int          // Memory limit in MB
  disk            Int          // Disk limit in MB
  cpu             Int          @default(100) // CPU limit percentage
  startup         String       // Startup command (from egg or custom)
  dockerImage     String?      @map("docker_image") // Selected docker image
  installed       Boolean      @default(false) // Whether installation completed
  status          String       @default("OFFLINE")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  node        Node         @relation(fields: [nodeId], references: [id])
  owner       User         @relation(fields: [ownerId], references: [id])
  egg         Egg?         @relation(fields: [eggId], references: [id])
  allocation  Allocation?
  variables   ServerVariable[]
  subusers    Subuser[]
  backups     Backup[]
  schedules   Schedule[]
  mounts      ServerMount[]
  databases   Database[]

  @@map("servers")
}

model ServerVariable {
  id          String   @id @default(uuid())
  serverId    String   @map("server_id")
  name        String
  envVariable String   @map("env_variable")
  value       String

  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@unique([serverId, envVariable])
  @@map("server_variables")
}

model Subuser {
  id          String   @id @default(uuid())
  serverId    String   @map("server_id")
  userId      String   @map("user_id")
  permissions String   // JSON string of permission array

  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([serverId, userId])
  @@map("subusers")
}

model Backup {
  id          String       @id @default(uuid())
  serverId    String       @map("server_id")
  name        String
  size        BigInt?      // Size in bytes
  status      String       @default("PENDING")
  checksum    String?
  storagePath String?      @map("storage_path")
  completedAt DateTime?    @map("completed_at")
  createdAt   DateTime     @default(now()) @map("created_at")

  server      Server       @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@map("backups")
}

model Schedule {
  id         String   @id @default(uuid())
  serverId   String   @map("server_id")
  name       String
  cron       String   // Cron expression
  action     String   // Action to perform (restart, backup, command)
  payload    String?  // Additional payload (e.g., command to run)
  isActive   Boolean  @default(true) @map("is_active")
  lastRunAt  DateTime? @map("last_run_at")
  nextRunAt  DateTime? @map("next_run_at")
  createdAt  DateTime @default(now()) @map("created_at")

  server     Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@map("schedules")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  action    String   // e.g., "server.create", "user.delete"
  metadata  String?  // JSON string of details
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

model Setting {
  key   String @id
  value String

  @@map("settings")
}

model Mount {
  id        String   @id @default(uuid())
  name      String
  source    String   // Path on the host (Node)
  target    String   // Path in the container
  readOnly  Boolean  @default(false) @map("read_only")
  
  nodeId    String   @map("node_id")
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  servers   ServerMount[]

  @@map("mounts")
}

model ServerMount {
  id        String   @id @default(uuid())
  serverId  String   @map("server_id")
  mountId   String   @map("mount_id")

  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  mount     Mount    @relation(fields: [mountId], references: [id], onDelete: Cascade)

  @@unique([serverId, mountId])
  @@map("server_mounts")
}

model Invitation {
  id          String   @id @default(uuid())
  email       String
  token       String   @unique
  serverId    String   @map("server_id")
  permissions String   // JSON string of permission array
  invitedBy   String   @map("invited_by")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  inviter     User     @relation("InvitedByUser", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@map("invitations")
}

model DatabaseHost {
  id        String   @id @default(uuid())
  name      String
  host      String
  port      Int
  username  String
  password  String
  nodeId    String?  @map("node_id")
  
  node      Node?    @relation(fields: [nodeId], references: [id])
  databases Database[]

  @@map("database_hosts")
}

model Database {
  id             String       @id @default(uuid())
  serverId       String       @map("server_id")
  hostId         String       @map("host_id")
  database       String
  username       String
  password       String
  remote         String       @default("%")
  createdAt      DateTime     @default(now()) @map("created_at")

  server         Server       @relation(fields: [serverId], references: [id], onDelete: Cascade)
  host           DatabaseHost @relation(fields: [hostId], references: [id], onDelete: Cascade)

  @@map("databases")
}

// AI Assistant Models
model AIConversation {
  id        String   @id @default(uuid())
  serverId  String   @map("server_id")
  userId    String   @map("user_id")
  messages  String   // JSON array of messages
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  actions   AIAction[]

  @@map("ai_conversations")
}

model AIAction {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  type           String   // download_plugin, modify_config, etc.
  description    String
  data           String   // JSON action data
  status         String   @default("pending") // pending, approved, executed, rejected, failed
  result         String?
  createdAt      DateTime @default(now()) @map("created_at")

  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("ai_actions")
}
